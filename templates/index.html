<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestionnaire de t√¢ches</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background-color: #f8f9fa; color: #1f2937; }
.task-done span { text-decoration: line-through; color: gray; }
.task-card { box-shadow: 0 2px 6px rgba(0,0,0,0.08); border-radius: 10px; }
.btn-icon { padding: 0.3rem 0.5rem; }
</style>
</head>
<body>
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card task-card p-4">
        <h3 class="text-center mb-4">üìù Gestionnaire de t√¢ches</h3>

        <!-- üîë Section login/registration -->
        <div id="auth-section">
          <div id="login-form">
            <h5>Connexion</h5>
            <input type="text" id="login-username" class="form-control mb-2" placeholder="Username">
            <input type="password" id="login-password" class="form-control mb-2" placeholder="Password">
            <button class="btn btn-primary w-100 mb-2" onclick="loginUser()">Se connecter</button>
            <p>Pas de compte ? <a href="#" onclick="showRegister()">Cr√©er un compte</a></p>
          </div>
          <div id="register-form" style="display:none;">
            <h5>Cr√©er un compte</h5>
            <input type="text" id="reg-username" class="form-control mb-2" placeholder="Username">
            <input type="password" id="reg-password" class="form-control mb-2" placeholder="Password">
            <button class="btn btn-success w-100 mb-2" onclick="registerUser()">S'enregistrer</button>
            <p>D√©j√† un compte ? <a href="#" onclick="showLogin()">Se connecter</a></p>
          </div>
          <div id="auth-message" class="text-danger mb-2"></div>
        </div>

        <!-- ‚úÖ Section t√¢ches (cach√©e tant que pas connect√©) -->
        <div id="tasks-section" style="display:none;">
          <form id="task-form" class="d-flex mb-4">
            <input type="text" id="task-input" class="form-control me-2" placeholder="Nouvelle t√¢che..." required>
            <button type="submit" class="btn btn-primary">Ajouter</button>
          </form>
          <h5 class="text-primary mb-2">T√¢ches en cours</h5>
          <ul id="task-list-active" class="list-group list-group-flush mb-4"></ul>
          <h5 class="text-success mb-2">T√¢ches termin√©es</h5>
          <ul id="task-list-done" class="list-group list-group-flush"></ul>
          <button class="btn btn-secondary mt-2" onclick="logout()">Se d√©connecter</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let token = null;

function showRegister() {
  document.getElementById("login-form").style.display="none";
  document.getElementById("register-form").style.display="block";
  document.getElementById("auth-message").innerText="";
}
function showLogin() {
  document.getElementById("login-form").style.display="block";
  document.getElementById("register-form").style.display="none";
  document.getElementById("auth-message").innerText="";
}

// üîê Auth
async function loginUser() {
  const username = document.getElementById("login-username").value;
  const password = document.getElementById("login-password").value;
  const res = await fetch("/login", {
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username,password})
  });
  const data = await res.json();
  if(res.ok){ token = data.access_token; showTasks(); fetchTasks(); }
  else { document.getElementById("auth-message").innerText = data.error; }
}

async function registerUser() {
  const username = document.getElementById("reg-username").value;
  const password = document.getElementById("reg-password").value;
  const res = await fetch("/register", {
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username,password})
  });
  const data = await res.json();
  if(res.ok){ document.getElementById("auth-message").innerText="Compte cr√©√© ! Connectez-vous."; showLogin();}
  else { document.getElementById("auth-message").innerText = data.error; }
}

function showTasks() {
  document.getElementById("auth-section").style.display="none";
  document.getElementById("tasks-section").style.display="block";
}

function logout() {
  token = null;
  document.getElementById("tasks-section").style.display="none";
  document.getElementById("auth-section").style.display="block";
  document.getElementById("login-username").value="";
  document.getElementById("login-password").value="";
}

// ‚úÖ Gestion des t√¢ches
const API_URL="/tasks";
async function fetchTasks() {
  const res = await fetch(API_URL, { headers: { Authorization:`Bearer ${token}` } });
  const data = await res.json();
  renderTasks(data);
}

function renderTasks(tasks){
  const activeList = document.getElementById("task-list-active");
  const doneList = document.getElementById("task-list-done");
  activeList.innerHTML=""; doneList.innerHTML="";
  tasks.filter(t=>!t.done).forEach(t=>activeList.appendChild(createTaskItem(t)));
  tasks.filter(t=>t.done).forEach(t=>doneList.appendChild(createTaskItem(t)));
}

function createTaskItem(t){
  const li=document.createElement("li");
  li.className="list-group-item d-flex justify-content-between align-items-center";
  if(t.done) li.classList.add("task-done");
  li.innerHTML = `
    <span>${t.title}</span>
    <div>
      <button class="btn btn-success btn-sm btn-icon" onclick="toggleTask(${t.id},${!t.done})">${t.done?"‚Ü©Ô∏è":"‚úîÔ∏è"}</button>
      <button class="btn btn-danger btn-sm btn-icon" onclick="deleteTask(${t.id})">üóëÔ∏è</button>
    </div>`;
  return li;
}

document.getElementById("task-form").addEventListener("submit",(e)=>{
  e.preventDefault();
  const title=document.getElementById("task-input").value.trim();
  if(title){ addTask(title); document.getElementById("task-input").value=""; }
});

async function addTask(title){
  await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json", Authorization:`Bearer ${token}`}, body:JSON.stringify({title})});
  fetchTasks();
}
async function deleteTask(id){
  await fetch(`${API_URL}/${id}`,{method:"DELETE", headers:{Authorization:`Bearer ${token}`}});
  fetchTasks();
}
async function toggleTask(id,done){
  await fetch(`${API_URL}/${id}`,{method:"PUT", headers:{"Content-Type":"application/json", Authorization:`Bearer ${token}`}, body:JSON.stringify({done})});
  fetchTasks();
}
</script>
</body>
</html>